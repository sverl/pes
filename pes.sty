\RequirePackage{expl3}
\ProvidesExplPackage{pes}{2018/02/09}{0.1}{Potential energy surfaces.}

\RequirePackage{l3keys2e}

\RequirePackage{siunitx}
\DeclareSIUnit[number-unit-product = {}] \Hartree {Ha}

\RequirePackage{pgfplots}
\pgfplotsset{compat=1.15}

% Module keys
\keys_define:nn {pes} {
	env .tl_set:N = \pes_env,
	env .initial:n = {figure},
	
	width .tl_set:N = \pes_width,
	width .initial:n = {\axisdefaultwidth},
	
	height .tl_set:N = \pes_height,
	height .initial:n = {\axisdefaultheight},
	
	xlabel .tl_set:N = \pes_xlabel,
	xlabel .initial:n = {reaction~coordinate},
	
	ylabel .tl_set:N = \pes_ylabel,
	ylabel .initial:n = {$E/\si{\Hartree}$},	
}
\ProcessKeysOptions{pes}

% Environment keys
\keys_define:nn {pes/env} {
	env .tl_set:N = \pes_env,
	env .default:n = {figure},
	
	width .tl_set:N = \pes_width,
	width .default:n = {\axisdefaultwidth},
	
	height .tl_set:N = \pes_height,
	height .default:n = {\axisdefaultheight},
	
	xlabel .tl_set:N = \pes_xlabel,
	xlabel .default:n = {reaction~coordinate},
	
	ylabel .tl_set:N = \pes_ylabel,
	ylabel .default:n = {$E/\si{\Hartree}$},
	
	caption .tl_set:N = \pes_caption,
	
	label .tl_set:N = \pes_label,
	
	zero .tl_set:N = \pes_zero,
	zero .initial:n = {0},
}

% Define environment
\NewDocumentEnvironment{pes}{O{}}{	
	% Process the environment keys
	\keys_set:nn {pes/env}{#1}
	
	\begin{\pes_env}
		\centering
		\begin{tikzpicture}
		\begin{axis}[width=\pes_width,
		height=\pes_height,
		axis~lines=left,
		enlarge~x~limits=0.2,
		enlarge~y~limits=0.2,
		xlabel=\pes_xlabel,
		ylabel=\pes_ylabel,
		xmajorticks=false]
	}{
		\end{axis}
		\end{tikzpicture}
		
		\tl_if_empty:NF \pes_caption {\caption{\pes_caption}}
		\tl_if_empty:NF \pes_label {\label{\pes_label}}
		
	\end{\pes_env}
}

% Styles
\tikzset{coord/.style={mark=none}}

\tikzset{level/.style={minimum~width=8mm}}
\tikzset{levelline/.style={ultra~thick}}
\tikzset{levellabel/.style={node~distance=1em}}

\tikzset{edge/.style={}}

\tikzset{graphics/.style={above}}

% Environment commands
\NewDocumentCommand{\level}{mmmo}{
	\addplot[coord]coordinates{(#2,#3-\pes_zero)}
	node(#1)[level]{}
	\IfValueT{#4}{
		node[graphics]{#4}
	};
	\draw[levelline](#1.west)--(#1.east);
	\node[levellabel,below~of=#1]{#1};
}

\NewDocumentCommand{\edge}{mm}{	
	\draw[edge](#1.east)--(#2.west);
}